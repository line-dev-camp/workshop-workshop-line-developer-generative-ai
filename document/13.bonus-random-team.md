# Usecase Random Group 

<p align="center" width="100%">
    <img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LFZ9LP4zVxoFjUSVlwdgEQ.png"> 
</p>

Solution
- ‡πÄ‡∏ä‡∏¥‡∏ç bot ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°
- ‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏ï‡πä‡∏∞‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á
- Bot ‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ô‡∏±‡πà‡∏á‡πÇ‡∏ï‡πä‡∏∞‡∏Ñ‡∏•‡∏∞‡∏Å‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏° 

<p align="center" width="100%">
    <img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FUQZC9p7IBaqK2giipyNrA.png
    "> 
</p>

‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡πÅ‡∏£‡∏Å‡∏ß‡πà‡∏≤ ‡πÅ‡∏ï‡∏Å ‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢ {{‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô ‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÇ‡∏ï‡πä‡∏∞}} ‡πÄ‡∏ä‡πà‡∏ô

‡πÅ‡∏ï‡∏Å 4 4
==> ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á ‡∏°‡∏µ 2 ‡πÇ‡∏ï‡πä‡∏∞ ‡πÇ‡∏ï‡πä‡∏∞‡∏•‡∏∞ 4 ‡∏Ñ‡∏ô
‡πÅ‡∏ï‡∏Å 2 4 4
==> ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á ‡∏°‡∏µ 3 ‡πÇ‡∏ï‡πä‡∏∞
‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà 1 ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 2 ‡∏Ñ‡∏ô
‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà 2 ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 4 ‡∏Ñ‡∏ô
‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà 3 ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 4 ‡∏Ñ‡∏ô



src/random.js

````javascript
const {
    onRequest
} = require("firebase-functions/v2/https");
const line = require('../util/line.util');
const messages = require('../message/random');
const firebase = require('../util/firebase.util')


exports.receive = onRequest(async (request, response) => {

    if (request.method !== "POST") {
        return response.status(200).send("Method Not Allowed");
    }
    if (!line.verifySignature(request.headers["x-line-signature"], request.body)) {
        return response.status(401).send("Unauthorized");
    }

    const events = request.body.events

    for (const event of events) {

        if (event.source.type !== "group") {
            return response.status(200).send("Permission is Faled");
        }

        /*üî• 1. Join to Chat Group üî•
        https://developers.line.biz/en/reference/messaging-api/#join-event
        */
        if (event.type === "join") {
            await line.reply(event.replyToken, [messages.welcomeMessage()])
            return response.end();
        }

        /* üî• 2. Member Joined to Chat Group üî•
        https://developers.line.biz/en/reference/messaging-api/#member-joined-event
        }*/
        if (event.type === "memberJoined") {
            for (let member of event.joined.members) {
                if (member.type === "user") {
                    const profile = await line.getProfileByGroup(event.source.groupId, member.userId)

                    /* ‚úÖ 2.1 Firebase : Insert User to Group  */
                    await firebase.insertUserGroup(event.source.groupId, profile)

                    /* ‚úÖ 2.2 Firebase : Total Number User in Group  */
                    const countGroup = await firebase.countUserGroup(event.source.groupId)

                    /* ‚úÖ 2.3 Reply Member Joined to Chat Group  */
                    await line.reply(event.replyToken, [messages.memberJoinedMessage(profile.data.displayName, countGroup)])
                }
            }
            return response.end();
        }

        /* üî• 3. Event Message üî•
      https://developers.line.biz/en/reference/messaging-api/#message-event
       */
        if (event.type === "message" && event.message.type === "text") {

            /* ‚úÖ 3.1 insert User to Group  */
            await firebase.insertUserGroup(event.source.userId, event.source.groupId)

            let textMessage = event.message.text


            /* üö® Check Total Member Group From Database */
            if (textMessage === "‡∏ï‡∏µ‡πâ‡∏â‡∏±‡∏ô") {

                /* ‚úÖ 3.2 Firebase : Total Number User in Group */
                let countGroup = await firebase.countUserGroup(event.source.groupId)

                /* ‚úÖ 3.3 Reply Total Member Group */
                await line.reply(event.replyToken, [messages.summaryGroup(countGroup)])

                return response.end();
            }


            /* üöÄ main feature  */
            let splitStringMessage = textMessage.split(' ')
            let subStringMessage = splitStringMessage[0].substring(0, 4)
            if (subStringMessage === "‡πÅ‡∏ï‡∏Å") {

                /* ‚úÖ 3.4 Firebase : Total Number User in Group */
                let countGroup = await firebase.countUserGroup(event.source.groupId)

                /* üîé Validate Element Array from 
                    subStringMessage = ‡πÅ‡∏ï‡∏Å
                    splitStringMessage  = [‡πÅ‡∏ï‡∏Å, 4,4,4,5] 
                */
                const tableSizeArray = await validateAndExtractNumbers(splitStringMessage, subStringMessage)

                /* üîé Summary Array */
                const totalMember = tableSizeArray.reduce((acc, val) => acc + val, 0);

                /* ‚ùå [Reply Error Message] Table < 2 */
                if (tableSizeArray.length < 2) {
                    await line.reply(event.replyToken, [messages.countTableError(countGroup)]);
                    return response.end();
                }

                /* ‚ùå[reoply Error message] Summary group from array not equl all member in group  */
                if (countGroup !== totalMember) {
                    await line.reply(event.replyToken,  [messages.summaryGroupError(countGroup, totalMember)]);
                    return response.end();
                }

                /* ‚úÖ 3.5 Shuffle Table Group */
                await shuffleTableGroup(event.replyToken, event.source.groupId, tableSizeArray);
                return response.end();

            }

        }



        /* üî• 4. Member Leave From Chat Group üî•
        https://developers.line.biz/en/reference/messaging-api/#member-left-event
        */
        if (event.type === "memberLeft") {
            for (const member of event.left.members) {
                if (member.type === "user") {
                    await firebase.deleteUserGroup(member.userId, event.source.groupId)

                }
            }
            return response.end();
        }


        /* üî• 5. Leave From Chat Group üî•
        https://developers.line.biz/en/reference/messaging-api/#leave-event
        */
        if (event.type === "leave") {
            await firebase.deleteGroup(event.source.groupId)
            return response.end();
        }



    }
    return response.end();

});


async function validateAndExtractNumbers(splitMessages, excludedMessage) {
    return splitMessages
        .filter(message => message !== excludedMessage)
        .map(message => {
            const extractedNumber = Number(message.substring(0, 2));
            if (!isNaN(extractedNumber) && extractedNumber !== 0) {
                return extractedNumber;
            } else {
                throw new Error('‚ùå Invalid number format');
            }
        });
}

/*  Reply Message and Random User and Table */
async function shuffleTableGroup (replyToken, groupId, tableSizeArray) {

    // Fetch and shuffle user list
    const usersInGroup = await firebase.getUserGroup(groupId);
    const shuffledUsers = shuffleArray(usersInGroup);


    // Determine the number of tables
    const maxTables = 20;
    const tables = createTables(maxTables, tableSizeArray.length);


    // Distribute users across tables
    let currentTableIndex = 0;
    shuffledUsers.forEach(user => {
        tables[currentTableIndex].members.push(user);
        if (tables[currentTableIndex].members.length === parseInt(tableSizeArray[currentTableIndex])) {
            currentTableIndex++;
        }
    });


    // Construct the message report
    let reportMessage = '';
    tables.forEach((table, index) => {
        if (table.members.length > 0) {
            reportMessage += `‡πÇ‡∏ï‡πä‡∏∞ ${index + 1} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${table.members.length} ‡∏Ñ‡∏ô\n`;
            table.members.forEach((member, memberIndex) => {
                reportMessage += `\n ${memberIndex + 1}. ${member.displayName}`;
            });
            reportMessage += "\n------------------\n";
        }
    });

    reportMessage += "‡πÅ‡∏ï‡∏Å‡πÇ‡∏ï‡πä‡∏∞ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏Å‡πÅ‡∏¢‡∏Å ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏ï‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ô‡πâ‡∏≤";

    // Reply with the message
    await line.reply(replyToken,  [messages.namelist(reportMessage)]);
}

/*  Shuffle Array By Chat GPT */
async function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

/* Create Maximum Table */
async function createTables(maxTables, requiredTables) {
    if (requiredTables > maxTables) {
        return false;
    }
    const tables = [];
    for (let i = 0; i < maxTables; i++) {
        tables.push({
            members: []
        });
    }
    return tables;
}
````

message/random.js

````javascript
exports.welcomeMessage = () => {
    return {
        "type": "text",
        "text": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô ‡∏°‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡∏µ‡πâ‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞ ... ‡∏´‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏á ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå ‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏á‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÜ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞ ",
        "quickReply": {
            "items": [{
                "type": "action",
                "imageUrl": "https://cloud.ex10.tech/public/filestore/Role-0ffccdc7-6e08-11ed-ad02-e6a905c1c90f.jpg",
                "action": {
                    "type": "message",
                    "label": "‡∏ï‡∏µ‡πâ‡∏â‡∏±‡∏ô",
                    "text": "‡∏ï‡∏µ‡πâ‡∏â‡∏±‡∏ô"
                }
            }]
        }
    }
}

exports.memberJoinedMessage = (displayName, countGroup) => {
    return {
        "type": "text",
        "text": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ " + displayName + " ‡∏°‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ï‡∏Å...‡∏ï‡∏µ‡πâ!  ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏°‡∏µ " + countGroup + " ‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß",
        "quickReply": {
            "items": [{
                "type": "action",
                "imageUrl": "https://cloud.ex10.tech/public/filestore/Role-0ffccdc7-6e08-11ed-ad02-e6a905c1c90f.jpg",
                "action": {
                    "type": "message",
                    "label": "‡∏ï‡∏µ‡πâ‡∏â‡∏±‡∏ô",
                    "text": "‡∏ï‡∏µ‡πâ‡∏â‡∏±‡∏ô"
                }
            }]
        }
    }
}

exports.summaryGroup = (countGroup) => {
    return {
        type: "text",
        text: "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡∏ï‡∏µ‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ " + countGroup + " ‡∏Ñ‡∏ô ‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ô‡∏∞!"
    }
}


exports.summaryGroupError = (countGroup, totalMember) => {
    return {
        type: "text",
        text: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡πÇ‡∏ï‡πä‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á \ ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡πÇ‡∏ï‡πä‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô : " + countGroup + "  ‡πÅ‡∏ï‡πà‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ : " + totalMember + " \n\n ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!"
    }
}

exports.countTableError = (countGroup) => {
    return {
        type: "text",
        text: "‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏ï‡πä‡∏∞ ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 2 ‡πÇ‡∏ï‡πä‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô  \n\n ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:" + countGroup + " ‡∏Ñ‡∏ô"
    }
}

exports.namelist = (reportMessage) => {
    return {
        type: "text",
        text: reportMessage
    }
}
````